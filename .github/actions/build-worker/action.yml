name: "Build Worker"
description: "Build worker"
inputs:
  python-version:
    description: "Python version to use"
    required: true

runs:
  using: composite
  steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set target based on OS and arch
      shell: bash
      run: |
        if [[ "${RUNNER_OS}" == "Linux" ]]; then
          echo "TARGET=x86_64-unknown-linux-gnu" >> $GITHUB_ENV
        elif [[ "${RUNNER_OS}" == "macOS" ]]; then
          if [[ "${RUNNER_ARCH}" == "ARM64" ]]; then
            echo "TARGET=aarch64-apple-darwin" >> $GITHUB_ENV
          else
            echo "TARGET=x86_64-apple-darwin" >> $GITHUB_ENV
          fi
        elif [[ "${RUNNER_OS}" == "Windows" ]]; then
          echo "TARGET=x86_64-pc-windows-msvc" >> $GITHUB_ENV
        fi

    - name: Set up Python ${{ inputs.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ inputs.python-version }}

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable

    - name: Cache Rust
      uses: Swatinem/rust-cache@v2

    - name: Build
      shell: bash -euxo pipefail {0}
      run: scripts/build-worker.sh ${{ env.TARGET }}

    - name: Package the worker (Linux)
      if: runner.os == 'Linux'
      shell: bash -euxo pipefail {0}
      run: |
        cd dist
        mv fluxqueue-worker-${{ env.TARGET }} fluxqueue-worker
        tar -czvf fluxqueue-${{ github.ref_name }}-py${{ inputs.python-version }}-linux-x86_64.tar.gz fluxqueue-worker
        rm fluxqueue-worker

    - name: Package the worker (macOS)
      if: runner.os == 'macOS'
      shell: bash -euxo pipefail {0}
      run: |
        cd dist
        mv fluxqueue-worker-${{ env.TARGET }} fluxqueue-worker
        zip fluxqueue-${{ github.ref_name }}-py${{ inputs.python-version }}-${{ env.TARGET }}.zip fluxqueue-worker
        rm fluxqueue-worker

    - name: Package the worker (Windows)
      if: runner.os == 'Windows'
      shell: pwsh
      run: |
        cd dist
        mv fluxqueue-worker-${{ env.TARGET }}.exe fluxqueue-worker.exe
        Compress-Archive -Path fluxqueue-worker.exe -DestinationPath fluxqueue-${{ github.ref_name }}-py${{ inputs.python-version }}-windows-x86_64.zip 
        rm fluxqueue-worker.exe

    - name: Upload build artifact
      uses: actions/upload-artifact@v4
      with:
        name: fluxqueue-worker-${{ env.TARGET }}-py${{ inputs.python-version }}
        path: dist/*
